<!doctype html>
<html class="no-js" lang="">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Metadatum</title>
</head>
<body>
<style>html , body {
	width : 100% ;
	height : 100% ;
	margin : 0px ;
	border : 0 ;
	overflow : hidden ;
	display : block ; 
}</style>
<script>var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},i={compressToBase64:function(o){if(null==o)return"";var r=i._compress(o,6,function(o){return n.charAt(o)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(o){return null==o?"":""==o?null:i._decompress(o.length,16384,function(r){return o.charCodeAt(r)-32})},compressToUint8Array:function(o){for(var r=i.compress(o),n=new Uint8Array(2*r.length),e=0,t=r.length;t>e;e++){var s=r.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null===o||void 0===o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;t>e;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return e.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(n){return o(e,r.charAt(n))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(o,r,n){if(null==o)return"";var e,t,i,s={},p={},u="",c="",a="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(u=o.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==r-1){d.push(n(m));break}v++}return d.join("")},decompress:function(o){return null==o?"":""==o?null:i._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,n,e){var t,i,s,p,u,c,a,l,f=[],h=4,d=4,m=3,v="",w=[],A={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)f[i]=i;for(p=0,c=Math.pow(2,2),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(t=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 2:return""}for(f[3]=l,s=l,w.push(l);;){if(A.index>o)return"";for(p=0,c=Math.pow(2,m),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(l=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 2:return w.join("")}if(0==h&&(h=Math.pow(2,m),m++),f[l])v=f[l];else{if(l!==d)return null;v=s+s.charAt(0)}w.push(v),f[d++]=s+v.charAt(0),h--,s=v,0==h&&(h=Math.pow(2,m),m++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module&&(module.exports=LZString);</script>
<style>#maincanvas {
    padding : 0 ;
    margin : auto ;
    display : block ;
    cursor: crosshair;
}</style>
<script>var _pointerdown = false ;
var _pointere = [ ] ;
var _pointerx = [ ] ;
var _pointery = [ ] ;
var _pointerstrokes = [ ] ;
function _pointerReset( ) {
	_pointerdown = false ;
	_pointere = [ ] ;
	_pointerx = [ ] ;
	_pointery = [ ] ;
	_pointerstrokes = [ ] ;
} ;
function _pointerPos( evt ) {
	var rect = maincanvas.getBoundingClientRect( ) ;
	//console.log(rect);
	return {
	  x : Math.round( evt.clientX - rect.left ) ,
	  y : Math.round( evt.clientY - rect.top )
	} ;
} ;
function _pointerEnd( evt ) {
	//console.log( "pointerend" ) ;
	if( _pointerdown ) {
		var mousePos = _pointerPos( evt ) ;
		addPoint( "E" , mousePos.x , mousePos.y ) ;
		//_pointerstrokes.push( 0 ) ;
	}
	_pointerdown = false ;
	/*
	if( _pointerx.length > 0 ) {
		var lastStrokePos = strokes[ strokes.length-1 ] ;
		if( lastStrokePos != _pointerx.length ) {
			_pointerstrokes.push( _pointerx.length ) ;
		} ;
	} ;
	*/
} ;
function _pointerStart( evt ) {
	//console.log( "pointerstart" ) ;
	_pointerdown = true ;
	_pointerstrokes.push( 0 ) ;	
	var mousePos = _pointerPos( evt ) ;
	addPoint( "S" , mousePos.x , mousePos.y ) ;
} ;
function _pointerMove( evt ) {
	//console.log( "pointermove" ) ;
    //evt.preventDefault();
    //evt.stopPropagation();
	if( _pointerdown ) {
		var mousePos = _pointerPos( evt ) ;
        var x1 = _pointerx[ _pointerx.length - 1 ] ;
        var y1 = _pointery[ _pointery.length - 1 ] ;
        var x2 = mousePos.x ;
        var y2 = mousePos.y ;
        var d = Math.pow(x2-x1,2)+Math.pow(y2-y1,2);
        if(d>10){
    	
    		drawLine( _pointerx[ _pointerx.length - 1 ] , _pointery[ _pointery.length - 1 ] , mousePos.x , mousePos.y ) ;
    		addPoint( "M" , mousePos.x , mousePos.y ) ;
	   };
	} ;
} ;</script>
<canvas id="maincanvas" width="123" height="321">
<script>
var querystring = window.location.search ;
if( querystring == "" ) {
    window.location.href = "http://127.0.0.1/_craft_/metadatum/bookmarklet.html" ;
} ;
var query = JSON.parse( decodeURIComponent( window.location.search ).slice( 1 ) ) ;
//console.log( query ) ;
//////////////////////////////////////////////////////////
var maincanvas = document.getElementById( 'maincanvas' ) ;
maincanvas.style.width = window.innerWidth + 'px';
maincanvas.style.height = window.innerHeight+ 'px';
//ctx.canvas.width  = window.innerWidth;
//ctx.canvas.height = window.innerHeight;
maincanvas.width=window.innerWidth;
maincanvas.height=window.innerHeight;
var ctx = maincanvas.getContext( '2d' ) ;
//maincanvas.width=maincanvas.clientWidth;
//maincanvas.height=maincanvas.clientHeight;
maincanvas.addEventListener( 'mousedown' , _pointerStart, false ) ;
maincanvas.addEventListener( 'mousemove' , _pointerMove, false ) ;
maincanvas.addEventListener( 'mouseup'   , _pointerEnd , false  ) ;
maincanvas.addEventListener( 'mouseout'  , _pointerEnd, false   ) ;
//////////////////////////////////////////////////////////
var img = new Image( ) ;   
var fitImageOn = function( canvas , imageObj ) {
	var imageAspectRatio = imageObj.width / imageObj.height;
	var canvasAspectRatio = canvas.width / canvas.height;
	var renderableHeight, renderableWidth, xStart, yStart;
	if( imageAspectRatio < canvasAspectRatio ) {
		renderableHeight = canvas.height ;
		renderableWidth = imageObj.width * ( renderableHeight / imageObj.height ) ;
		xStart = ( canvas.width - renderableWidth ) / 2 ;
		yStart = 0;
	} else if( imageAspectRatio > canvasAspectRatio ) {
		renderableWidth = canvas.width
		renderableHeight = imageObj.height * ( renderableWidth / imageObj.width ) ;
		xStart = 0 ;
		yStart = ( canvas.height - renderableHeight ) / 2 ;
	} else {
		renderableHeight = canvas.height ;
		renderableWidth = canvas.width ;
		xStart = 0 ;
		yStart = 0 ;
	} ;
	ctx.drawImage( imageObj , xStart , yStart , renderableWidth , renderableHeight ) ;
};
img.addEventListener( 'load' , function( ) {
	imageInit( ) ;
} , false ) ;
function imageInit( ) {
	fitImageOn( maincanvas , img ) ;
	if( query[ "editor" ] != null ) {
		fromData( query[ "editor" ] ) ;
		redraw( ) ;
	} ;	
}
img.src = query[ "l" ] ;
initialize( ) ;
function initialize( ) {
	window.addEventListener('resize', resizeCanvas, false);
	resizeCanvas();
}
			
function resizeCanvas( ) {
	var oldw = maincanvas.width ;
	var oldh = maincanvas.height ;
	var neww = window.innerWidth ;
	var newh = window.innerHeight ;
	console.log( oldw + "," + oldh + " -> " + neww + "," + newh ) ;
	maincanvas.width = window.innerWidth;
	maincanvas.height = window.innerHeight;
	maincanvas.style.width = window.innerWidth + 'px';
	maincanvas.style.height = window.innerHeight + 'px';
    drawPattern();
	fitImageOn( maincanvas , img ) ;
	var iw = img.width ;
	var ih = img.height ;
	//console.log( iw + "," + ih ) ;
	redraw( ) ;
}
//////////////////////////////////////////////////////////
function redraw( ) {
	var i , j ;
	var pindex = 0 ;
	var x1 , y1 ;
	for( i = 0 ; i < _pointerstrokes.length ; i++ ) {
		for( j = _pointerstrokes[ i ] ; j > 0 ; j-- ) {
			var pe = _pointere[ pindex ] ;
			var px = _pointerx[ pindex ] ;
			var py = _pointery[ pindex ] ;
			if( pe != "S" ) {
				drawLine( x1,y1 , px , py ) ;
			} ;
			x1 = px ;
			y1 = py ;
			pindex++ ;
		} ;
	} ;
} ;
//////////////////////////////////////////////////////////
function drawLine( x1 , y1 , x2 , y2 ) {
    //y1=100;
    var w1 = 7 ;
    var w2 = 3 ;
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.lineWidth = w1 ;
	ctx.beginPath( ) ;
	ctx.moveTo( x1 , y1 ) ;
	ctx.lineTo( x2 , y2 ) ;
	ctx.stroke( ) ;
    ctx.closePath( ) ;
    ctx.lineWidth = w2 ;
    ctx.strokeStyle = '#FFFFFF' ;
	ctx.beginPath( ) ;
	ctx.moveTo( x1 , y1 ) ;
	ctx.lineTo( x2 , y2 ) ;
	ctx.stroke( ) ;
    ctx.closePath( ) ;
    ctx.beginPath( ) ;
    ctx.fillStyle = '#FFFFFF' ;
    ctx.arc( x1 , y1 , w2 - 1 , 0 , 2 * Math.PI , false ) ;
    ctx.fill( ) ;
    ctx.closePath( ) ;
    ctx.beginPath( ) ;
    ctx.fillStyle = '#FFFFFF' ;
    ctx.arc( x2 , y2 , w2 - 1 , 0 , 2 * Math.PI , false ) ;
    ctx.fill( ) ;
    ctx.closePath( ) ;
} ;
function drawPattern( ) {
    var i,j ;
    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
    ctx.lineWidth = 1 ;
    j=Math.round(maincanvas.width/20);
    for(i=0;i<maincanvas.width;i+=j){
        ctx.beginPath( ) ;
        ctx.moveTo( i  , 0 ) ;
        ctx.lineTo( i , maincanvas.height) ;
        ctx.stroke( ) ;
        ctx.closePath( ) ;
    };
    j=Math.round(maincanvas.height/20);
    for(i=0;i<maincanvas.height;i+=j){
        ctx.beginPath( ) ;
        ctx.moveTo( 0  , i ) ;
        ctx.lineTo( maincanvas.width , i ) ;
        ctx.stroke( ) ;
        ctx.closePath( ) ;
    }
} ;
function addPoint( pe , px , py ) {	
	_pointere.push( pe ) ;
	_pointerx.push( px ) ;
	_pointery.push( py ) ;
	_pointerstrokes[ _pointerstrokes.length - 1 ]++ ;
} ;
function toData( ) {
	// total strokes , stroke1 length, stroke2 length, .... , e1,x1,y1 ....
	var data = [ ] ;
	var i , j , k ;
	j = _pointerstrokes.length ;
	data.push( j ) ;
	//k = 0 ;
	for( var i = 0 ; i < j ; i++ ) {
		data.push( _pointerstrokes[ i ] ) ;
		//k+=_pointerstrokes[ i ] ;
	};
	//console.log(k);
	//console.log(k*3);
	j = _pointerx.length ;
	//console.log(j);
	//console.log(j*3);
	for( i = 0 ; i < j ; i++ ) {
		data.push( _pointere[ i ] ) ;
		data.push( _pointerx[ i ] ) ;
		data.push( _pointery[ i ] ) ;
	} ;
	//console.log(data);
	return( data ) ;
} ;
function fromData( data ) {
	//console.log(data);
	_pointerReset( ) ;
	var i , j , k ;
	var totalStrokes = data[ 0 ] ;
	var totalPoints = 0 ;
	for( i = 0 ; i < totalStrokes ; i++ ) {
		j = data[ 1 + i ] ;
		_pointerstrokes.push( data[ 1 + i ] ) ;
		totalPoints += j ;
	} ;
	var t1 = totalStrokes + 1 ;
	var t2 = t1 + ( totalPoints * 3 ) ;
	//console.log(t1+" -> "+t2);
	for( k = t1 ; k < t2 ; k += 3 ) {
		_pointere.push( data[ k ] ) ;
		_pointerx.push( data[ k + 1 ] ) ;
		_pointery.push( data[ k + 2 ] ) ;
	}
	//console.log( _pointerstrokes ) ;
	//console.log( _pointere) ;
	//console.log( _pointerx) ;
	//console.log( _pointery) ;
}
//////////////////////////////////////////////////////////
function createUrlRedirect( ) {
	query[ "editor" ] = toData( ) ;
	window.location.href = "editor.html?" + encodeURIComponent( JSON.stringify( query ) ) ;
	return(false);
} ;
</script>
</body>
</html>